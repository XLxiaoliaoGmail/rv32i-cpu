# RISC-V RV32I 多周期CPU设计

## 项目简介
这是一个基于RISC-V-32I指令集的32位多周期CPU设计项目。采用SystemVerilog硬件描述语言实现，支持基础指令系统，包括算术运算、分支跳转以及内存访问操作，实现了指令缓存和内存缓存，ALU在不同阶段执行不同功能，各模块间均通过请求-响应形式通信。

使用Modelsim进行了仿真验证。

![image](https://github.com/user-attachments/assets/54cfda25-1927-4999-8334-6e444dc1b8f1)

## **核心特性**
- **多周期执行**: 指令执行分为五个精确控制的阶段
  - 取指 (Instruction Fetch)
  - 译码 (Decode)
  - 执行 (Execute)
  - 访存 (Memory Access)
  - 写回 (Write Back)

- **高效的控制结构**
  - 采用状态机动态调度各执行阶段
  - 根据指令类型智能选择必要阶段

- **模块化设计**
  - 各功能模块通过标准化接口定义
  - 采用集中式控制，所有模块与控制单元直接通信
  - 使用请求-响应通信模式，确保可靠数据传输

- **ALU复用**
  - 单一ALU多功能复用，支持：
    - 基础算术运算
    - 条件分支判断
    - 跳转地址计算
    - 内存地址偏移运算

- **缓存特性**
  - 实现指令与数据缓存机制
  - 使用AXI协议与存储器通信
  - 指令缓存仅支持读取
  - 数据缓存可读写
  - 数据缓存模块运行描述如下
  <img src="https://github.com/user-attachments/assets/d87043b4-989d-453e-8d69-1aa2a2666901" width="60%">

## 测试验证

本项目通过多个测试文件和测试用例验证CPU整体和关键模块的功能：

### 模块测试

#### 指令缓存测试 (_tb_icache.sv)
- 验证缓存缺失(Cache Miss)和命中(Cache Hit)机制
- 测试不同缓存路的数据填充
- 验证LRU(最近最少使用)替换策略

#### 数据缓存测试 (_tb_dcache.sv)
- 测试不同数据宽度的读写操作(字/半字/字节)
- 验证符号扩展和零扩展功能
- 测试缓存替换策略
- 验证非对齐访问处理
- 测试缓存一致性

### 整体功能测试

通过imem.sv模块加载不同的测试程序，验证CPU对各类指令的支持：

#### ALU指令测试 (alu_test.bin)
- 基本算术运算：加减法
- 逻辑运算：与、或、异或
- 移位操作：逻辑左移、逻辑右移、算术右移
- 比较运算：有符号和无符号比较

#### 分支跳转测试 (branch_jump_test.bin)
- 条件分支指令(BEQ, BNE, BLT, BGE, BLTU, BGEU)
- 无条件跳转(JAL)
- 间接跳转(JALR)

#### 内存访问测试 (mem_test.bin)
- 字/半字/字节的加载指令(LW, LH, LB, LHU, LBU)
- 字/半字/字节的存储指令(SW, SH, SB)
- 地址对齐检查
- 数据扩展处理

## 模块说明

### 控制单元 (control_unit)
控制单元是整个CPU的中枢，负责协调各个功能模块的工作：
- 实现PC（程序计数器）的更新控制
- 处理分支和跳转指令的控制逻辑
- 协调各个功能模块的请求和响应
- 实现数据通路的控制
- 管理各个执行阶段的状态转换

### ALU模块 (alu)
算术逻辑单元，支持RISC-V基本整数指令集的所有运算：
- 基本算术运算：加、减、与、或、异或
- 移位操作：逻辑左移、逻辑右移、算术右移
- 比较运算：有符号比较、无符号比较
- 模拟了计算延迟
- 采用请求-响应通信机制

### 指令缓存 (icache)
指令缓存模块，优化指令获取效率：
- 实现两路组相联的缓存结构
- 使用LRU替换策略
- 使用AXI总线接口

### 指令存储器 (imem)
指令存储器模块：
- 支持从文件加载程序
- 使用AXI总线接口
- 模拟了存储器访问延迟

### 数据缓存 (dcache)
数据缓存模块，优化数据访问效率：
- 实现两路组相联的缓存结构
- 使用LRU替换策略，替换数据前会先写回
- 使用AXI总线接口
- 支持不同粒度的数据访问（字节、半字、字）
- 实现数据的符号扩展
- 支持字节对齐的访问操作

### 数据存储器 (dmem)
指令存储器模块：
- 使用AXI总线接口
- 模拟了存储器操作延迟

### 指令译码器 (idecoder)
指令解码模块，完成指令的解析工作：
- 支持所有RISC-V RV32I基本指令集的解码
- 提取指令中的操作码、功能码、寄存器地址和立即数
- 实现指令字段的正确扩展
- 模拟了解码延迟

### 寄存器文件 (reg_file)
通用寄存器组模块：
- 支持双端口读取和单端口写入
- 实现写优先级控制
- 支持数据前递（写后读）

### 状态机 (state_machine)
指令执行状态控制模块：
- 实现五阶段执行状态的转换控制
- 根据指令类型决定执行路径
- 控制指令流水的推进
- 处理特殊指令的状态转换

